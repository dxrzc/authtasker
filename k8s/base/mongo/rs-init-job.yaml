# Initializes MongoDB Replica Set
apiVersion: batch/v1
kind: Job
metadata:
  name: mongo-rs-init
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: mongo:7
          command:
            - bash
            - -c
            - |
              set -e              
              echo "Waiting for mongodb to be ready..."              
              sleep 10              
              mongosh "mongodb://mongo-svc:27017/admin" --quiet <<'EOF'
              try { 
                rs.status() 
              } catch (err) { 
                rs.initiate({_id:'rs0',members:[{_id:0,host:'mongo-svc:27017'}]}) 
              }
              EOF
